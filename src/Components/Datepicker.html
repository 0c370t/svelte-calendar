<div class="datepicker">
  <Popover>
    <div slot="trigger">
      <a href="#open-calendar" class="calendar-button">Open Calendar</a>
    </div>
    <div slot="contents">
      <div class="calendar">
        <NavBar 
          {month} 
          {year}
          {canIncrementMonth}
          {canDecrementMonth}
          on:monthSelected="changeMonth(event)" 
          on:incrementMonth="incrementMonth(event)"
        />
        <div class="legend">
          {#each dayDict as day}
            <span>{day.abbrev}</span>
          {/each}
        </div>
        <Months {months} {month} {year} {monthIndex}/>
      </div>
    </div>
  </Popover>
</div>

<style>

  .datepicker { 
    width: 300px;
    margin: 0 auto;
    /* margin: 154px auto 0 auto;  */
  }
  .calendar-button { 
        padding: 10px 20px;
    border: 1px solid #eee;
    display: block;
    text-align: center;
  }
  html {
    box-sizing: border-box;
  }
  *, *:before, *:after {
    box-sizing: inherit;
  }
  .weeks-container { 
    height: 311px;
  }
  .calendar { 
    box-sizing: border-box;
    width: 320px;
    box-sizing: content-box;
    position: relative;
    overflow: hidden;
    user-select: none;
  }
  .legend { 
    color: #4a4a4a;
    padding: 10px 0;
    margin-bottom: 5px;
  }
  .legend span { 
    width: 14.285714%;
    display: inline-block;
    text-align: center;
  }

  .flex-container {
    padding: 0;
    margin: 0;
    list-style: none;
    display: -webkit-box;
    display: -moz-box;
    display: -ms-flexbox;
    display: -webkit-flex;
    display: flex;
    -webkit-flex-flow: row;
    justify-content: space-around;
    line-height:30px;
  }
  .flex-item {
    background: tomato;
    margin: 5px;
    color: white;
    font-weight: bold;
    text-align: center;
    font-size: 1.5em;
    flex: 1 0 auto;
    height:auto;
    display: flex; 
  }
  .flex-item:before {
    content:'';
    float:left;
    padding-top:100%;
  }
  .flex-item-inner { 
    display: flex;
    justify-content: center;
    flex-direction: column;
    width: 100%;
  }
</style>

<script>
  import {dayDict} from './lib/dictionaries';
  import {getMonths} from './lib/helpers';
  let today = new Date();
  export default { 
    data() { 
      let today = new Date(); 
      return { 
        today,
        dayDict,
        start: new Date(1987, 9, 29), 
        end: new Date(2020, 9, 29),
        selected: today, 
        month: today.getMonth(), 
        year: today.getFullYear()
      }
    },
    computed: { 
      months: ({start, end}) => getMonths(start,end),
      monthIndex:  ({month,year,months}) => { 
        for(let i = 0; i < months.length; ++i) { 
          if(months[i].month == month && months[i].year == year) return i
        }
        return 0; 
      },
      canIncrementMonth: ({monthIndex,months}) => monthIndex < months.length -1,
      canDecrementMonth: ({monthIndex,months}) => monthIndex > 0
    },
    methods: { 
      changeMonth(month) { 
        console.log('month',month);
        this.set({month});
      },
      incrementMonth(direction) {
        let { canIncrementMonth, canDecrementMonth, month, year } = this.get(); 
        if(direction == 1 && !canIncrementMonth) return;
        if(direction == -1 && !canDecrementMonth) return;
        let current = new Date(year,month,1); 
        current.setMonth(current.getMonth() + direction); 
        this.set({
          month: current.getMonth(),
          year: current.getFullYear()
        })
      }
    },
    oncreate() { 
      let { selected } = this.get(); 
      this.set({
        month: selected.getMonth(), 
        year: selected.getFullYear()
      });
    },
    components: { 
      Months: './Months.html',
      NavBar: './NavBar.html',
      Popover: './Popover.html'
    }
  }
</script>